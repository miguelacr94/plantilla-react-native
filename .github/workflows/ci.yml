name: Expo CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-and-deploy:
    name: Test and Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ğŸ›‘ Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.11.0
        with:
          access_token: ${{ github.token }}

      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ£ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'
          cache-dependency-path: '**/package-lock.json'

      - name: ğŸ” Debug Info
        run: |
          echo "Node.js version: $(node -v)"
          echo "npm version: $(npm -v)"
          echo "Current directory: $(pwd)"
          ls -la

      - name: ğŸ›  Install Dependencies
        run: |
          npm install -g eas-cli@latest expo-cli@latest expo-doctor
          npm ci --legacy-peer-deps --prefer-offline --no-audit --no-fund

      - name: ğŸ” Check EAS Configuration
        run: |
          echo "EAS CLI Version: $(npx eas --version)"
          if [ -f "eas.json" ]; then
            echo "eas.json found:"
            cat eas.json
          else
            echo "Warning: eas.json not found"
          fi

      - name: ğŸ”‘ Expo Authentication
        if: github.ref == 'refs/heads/main'
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          npx expo whoami || npx expo login --token $EXPO_TOKEN

      - name: ğŸ§ª Run Tests (if configured)
        run: |
          if [ -f "package.json" ] && grep -q '"test":' package.json; then
            npm test -- --watchAll=false --passWithNoTests
          else
            echo "No test script found in package.json, skipping tests"
          fi

      - name: ğŸ—ï¸ Build Project
        run: |
          echo "ğŸ” Running Expo Doctor..."
          npx expo-doctor || echo "âš ï¸ Expo doctor check completed with warnings"
          
          echo "ğŸš€ Running Expo Prebuild..."
          npx expo prebuild --no-install || {
            echo "âŒ Expo prebuild failed"
            exit 1
          }
          
          echo "âœ… Build preparation completed successfully"

      - name: ğŸš€ Deploy with EAS Update
        if: github.ref == 'refs/heads/main'
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          EAS_PROJECT_ID: ${{ secrets.EXPO_PROJECT_ID }}
        run: |
          # Check if required environment variables are set
          if [ -z "$EXPO_TOKEN" ] || [ -z "$EAS_PROJECT_ID" ]; then
            echo "âŒ Missing required environment variables"
            echo "EXPO_TOKEN is set: ${EXPO_TOKEN:0:5}..."
            echo "EAS_PROJECT_ID is set: ${EAS_PROJECT_ID:0:5}..."
            exit 1
          fi

          echo "ğŸš€ Starting EAS Build..."
          npx eas-cli@latest build --platform all --non-interactive --no-wait || {
            echo "âŒ EAS Build failed"
            exit 1
          }

          echo "ğŸš€ Starting EAS Update..."
          npx eas-cli@latest update --branch production --message "GitHub Actions: ${{ github.sha }}" || {
            echo "âŒ EAS Update failed"
            exit 1
          }

          echo "âœ… Deployment completed successfully"

      - name: ğŸ Workflow Status
        if: always()
        run: |
          if [ "${{ job.status }}" == 'success' ]; then
            echo "ğŸ‰ All steps completed successfully!"
          else
            echo "âŒ Some steps failed. Check the logs above for details."
          fi
